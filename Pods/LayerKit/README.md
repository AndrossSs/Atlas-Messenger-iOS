# LayerKit

[![Build Status](http://jenkins-github.infra.layer.com/buildStatus/icon?job=LayerKit)](http://jenkins.infra.layer.com/job/LayerKit/)

This project contains the source code for LayerKit for iOS. The project is buildable as a framework for iOS and Mac OS X and contains a test suite
to exercise the code base.

## Getting Oriented

LayerKit is designed to be distributed to external developers with a simple, lightweight external API. Behind the scenes, the framework is
dealing with considerable complexity as it transparently handles synchronization and persistence concerns.

Please keep in mind the following as you work with the project:

1. There are a number of submodules that are necessary for compilation of the project.
1. Execution of the unit tests requires the installation of dependencies via [CocoaPods](http://cocoapods.org/)
1. The externally distributed header files represent a minority of the project interfaces.
1. Core Data is used internally as a persistence technology, but this is an implementation detail that is not exposed to end developers. There are a number of mapping classes that translate between persistant internal and transient external representations of the domain models.
1. The project has extensive automation tasks available via Rake. Run `rake -T` to see what is available. Xcode is **only** used for code editing and debugging. All project automation is exposed via Rake.
1. The use of Storyboards and XIBs is forbidden in the project. You must layout any views with code.
1. The project is under Continuous Integration provided by [Jenkins](http://jenkins-ci.org/). If you commit changes on a feature branch and open a Pull Request on Github, Jenkins will automatically build the branch and annotate the pull request. Jenkins is also configured to notify the #github slack channel of build status.
1. The use of Storyboards and XIBs is forbidden in the project. You must layout any views with code.


### Navigating the Project

The project is organized as detailed in the table below:

| Path                    | Type                  | Contains                                                                   |
| ------------------------|-----------------------|----------------------------------------------------------------------------|
| `Code`                  | Directory             | Source code organized by type                                              |
| `Documentation`         | Directory             | Composed project documentation                                             |
| `Documentation/API`     | Directory             | Appledoc generated documentation                                           |
| `Gemfile`               | Ruby code             | Ruby Gem dependency declarations for Bundler                               |
| `Gemfile.lock`          | ASCII text            | Exact Gem dependency manifest (generated by Bundler)                       |
| `LICENSE`               | ASCII text            | Licensing details for the project                                          |
| `Vendor`             	  | Directory             | Submodules and external project dependencies                               |
| `Podfile`               | Ruby code             | CocoaPods library dependencies for the project                             |
| `Podfile.lock`          | ASCII text            | Exact Pod dependency manifest (generated by CocoaPods)                     |
| `Pods`                  | Directory             | CocoaPods generated artifacts. Ignored by Git.                             |
| `README.md`             | Markdown text         | This comprehensive README file                                             |
| `Rakefile`              | Ruby source           | Rake automation tasks                                                      |
| `Resources`             | Directory             | Assets such images                                                         |
| `LayerKit.podspec`      | CocoaPods Spec (Ruby) | The CocoaPods spec for installing LayerKit into an external host app       |
| `LayerKit.xcodeproj`    | Xcode Project         | The Xcode project for LayerKit. Use the workspace instead.   			   |
| `LayerKit.xcworkspace`  | Xcode Workspace       | The Xcode workspace for LayerKit. Used for day to day development.         |
| `Tests`                 | Directory             | Unit and Functional Tests as well as Fixtures and the testing server code  |
| `VERSION`               | ASCII text            | The current version of the project in text                                 |
| `.ruby-version`         | rbenv configuration   | Specifies the version of Ruby that rbenv will bind to                      |
| `xcodebuild.log`        | Log file   			  | Log out xcodebuild output generated by test Rake tasks. Under .gitignore   |

## Developer Setup

In order to get a development environment up and running a number of pre-requisites must be installed and some basic configuration tasks performed.

### Checkout Git Submodules

`$ git submodule update --init --recursive`

### Install Xcode

1. Visit the Mac App Store and [Install Xcode](http://itunes.apple.com/us/app/xcode/id497799835?ls=1&mt=12).
2. Download and install the Xcode app to your Applications folder.
3. Launch Xcode and proceed through first launch configuration.

### Installing Dependencies via Rake

LayerKit requires the installation of a number of dependencies before performing day to day development work. Once Homebrew has been installed,
it can be used to bootstrap a development environment with all required dependencies. For convenience, all required dependencies can be installed
via a Rake task:

`$ rake init`

This task will take care of installing all required software for working on LayerKit. Specifically, the task does the following:

1. Checks if Homebrew has been installed and if it has not, installs it.
1. Updates the Homebrew package catalog and upgrades any outdated dependencies.
1. Installs various packages via Homebrew. See the Brewfile for details.
1. Checks for the version of Ruby specified in the .ruby-version file and installs it if necessary.
1. Checks for and installs Bundler if it not already installed.
1. Bundles all RubyGems dependencies specified in the Gemfile manifest.
1. Installs all CocoaPods dependencies specified in the Podfile manifest.

This task is designed to be safe to run repeatedly and is used to keep the CI environment up to date as well. A quick run through of the
dependencies discussed is outlined below for references.

#### Homebrew

Homebrew is a package manager for OS X useful for maintaining third-party UNIX software packages independent of the underlying OS X operating system.

#### Git & git-flow

While OS X does ship with Git pre-installed it can lag behind the most current stable releases. It is recommended that developers maintain up to date packages distributed via Homebrew. git-flow provides a branching strategy for feature, release, and maintenance branches wherein the master branch always represents the current stable production release.

Layer uses a customized git-flow configuration that is detailed [on the wiki](http://wiki.layer.com/doku.php?id=release_engineering:git_branching.md).

#### rbenv, ruby-build, & Ruby

As with Git, OS X ships with Ruby pre-installed but tends to lag greatly behind the current release versions and patch levels. OS X bundled Ruby distributions have also historically been subject to various technical short-comings when compared with installations built directly from source code due to underlying details of Apple's build process. As such, it is recommended that developers work with a Ruby interpretter built from source with a known version and patch level.

To handle the installation of Ruby interpretters from source code and manage multiple Ruby interpretters on the host system we recommend installing rbenv and ruby-build.

[rbenv](https://github.com/sstephenson/rbenv) is a simple, lightweight utility that handles the automatic selection of Ruby interpretters on a per project basis. [ruby-build](https://github.com/sstephenson/ruby-build) is a plugin for rbenv that handles the compilation and installation of Ruby interpretters from source code.

#### Bundler

[Bundler](http://bundler.io/) is a dependency manager for Ruby applications. It ensures that an exact runtime environment is configured for an application when executed. Bundler manages the Ruby gems that provide much of the testing infrastructure for this project and ensures that all developers are working with the same version of CocoaPods.

#### CocoaPods

[CocoaPods](http://cocoapods.org/) is a dependency manager for Objective-C applications. Much like Bundler, it resolves and configures dependencies for libraries that are used by an application. It is used to install all dependencies necessary to build this project and its test suite.

## Maintaining Project Dependencies

Keeping a project up to date is a straightforward task. You only need to ensure that Homebrew, Bundler, and CocoaPods are tracking the latest revisions. Keep an eye out for changes to the `Gemfile` and `Podfile` when changing branches or pulling updates -- they indicate that Bundler and CocoaPods dependencies, respectively, are out of date and need to be updated.

You can refresh all dependencies using the Rake task: `$ rbenv install -s && rake init`

Alternately, you can refresh the RubyGems via `$ bundle install`
and the CocoaPods via `bundle exec pod install`.

## Testing

LayerKit contains an extensive test suite covering all parts of the software. Testing is crucial for driving robust designs and maintaining confidence in a rapidly changing codebase. Please take the time to learn the testing tools available and integrate them into your workflow.

### Unit Testing

Unit testing is implemented on top of the XCTest, which is distributed with Xcode, and several third-party Open Source libraries that provide additional functionality such as mock objects and expressive test assertions:

* [OCMock](http://ocmock.org/) - OCMock is an Objective-C implementation of mock objects.
* [Expecta](https://github.com/petejkim/expecta) - Expecta is library of matchers and test assertions that do not require you to specify data types, resulting in much more succinct and expressive test code.

### Functional Testing

Functional Tests verify the behavior of LayerKit in app integration scenarios and components that require an AppKit environment to execute.

### Running Tests

Both types of tests can be run within Xcode or via the command line as detailed in the table below:

| Type        | Xcode Scheme                | Xcode Action    | Command Line            |
| ------------|-----------------------------|-----------------|------------------------ |
| Unit        | LayerKit                    | Test (&#8984;U) | `rake test:unit`        |
| Functional  | LayerKit                    | Test (&#8984;U) | `rake test:functional`  |

Additionally, the entire suite can be run from the commandline in aggregate by executing `rake test`.

The tests tasks are configured to log the full details of the underlying `xcodebuild` activities to `xcodebuild.log`.

#### Configuring Test Environment

The LayerKit test suite is set up to allow configuration of key testing setting via environment variables. This enables the easy, automated
testing of the client against different backend configurations. The table below enumerates the settings available:

| Environment Variable | Default Value  | Purpose                                                               |
| ---------------------|----------------|---------------------------------------------------------------------- |
| `LAYER_TEST_HOST`    | `@"localhost"` | Configures the remote TMC host to test against                        |
| `LAYER_LOG_LEVEL`    | `@"ERROR"`     | Configures the logging level (OFF, ERROR, WARN, INFO, DEBUG, VERBOSE) |

These variables can be configured directly within Xcode or provided via the Rake command line automation:

`$ rake test LAYER_TEST_HOST=smoke1.layer.com`

### Continuous Integration

The project is under continuous integration via [Jenkins](http://jenkins-ci.org/). You can visit the LayerKit Jenkins job: 
[here](http://jenkins.infra.layer.com/job/LayerKit/).

## Logging

LayerKit includes a robust logging framework built on top of [CocoaLumberjack](https://github.com/CocoaLumberjack/CocoaLumberjack).

### Log Levels

There are six log level defined:

1. `LOG_LEVEL_OFF` - Disable all LayerKit logging.
1. `LOG_LEVEL_ERROR` - Log only unexpected, non-recoverable runtime errors.
1. `LOG_LEVEL_WARN` - Log all errors including transient, potentially recoverable runtime and warnings.
1. `LOG_LEVEL_INFO` - Log informational runtime information.
1. `LOG_LEVEL_DEBUG` - Log additional debugging information.
1. `LOG_LEVEL_VERBOSE` - Log detailed runtime information.

### Log Configuration

Logging can be configured at build time or at run time. The default log level is configured at build time based on the value of the `LYR_LOG_LEVEL` preprocessor
definition. When undefined, it defaults to a value of `LOG_LEVEL_ERROR`.

Logging can also be configured via an environment variable if an invocation is made to the `LYRSetLogLevelFromEnvironment` function (see [Code/Private/Support/Logging/LYRLog.h]()).
This function configures the log level based on the value of the `LAYER_LOG_LEVEL` environment variable. Acceptable values are: `OFF`, `ERROR`, `WARN`, `INFO`, `DEBUG`, and `VERBOSE`.

### Logging Utilities

The LYRLog.h file includes some additional log related utilities that can be valuable during debugging. Examples include:

* `LYRLogWithLevelWhileExecutingBlock` - Temporarily sets the log level during the execution of a block, restoring its previous value upon exit.
* `LYRLogSilenceWhileExecutingBlock` - Silences all logging during the execution of a block.

The CocoaSPDY library has also been integrated with the logging environment.

## Generating Documentation

Documentation can be generated from [appledoc]() via Rake: `rake docs`.

## Contact

LayerKit was developed in San Francisco by the Layer team. If you have any technical questions or concerns about this project feel free to reach out to engineers responsible for the development:

* [Klemen Verdnik](mailto:klemen@layer.com)
* [Blake Watters](mailto:blake@layer.com)

## License

This project contains source code that is the exclusive intellectual property of Layer, Inc. It is intended for distribution in binary form as a proprietary product of Layer. This source code is to be accessed only by employees or authorized contractors of Layer.
